<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Support Desk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --panel:#121935; --muted:#7b8ab8; --text:#e8ecff; --accent:#6c8cff; --accent2:#36d399; --danger:#ff6b6b; --border:#213067;
    }
    *{ box-sizing: border-box; }
    body{ margin:0; background:linear-gradient(180deg,#0b1020 0%,#0e1530 100%); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app{ display:grid; grid-template-columns: 320px 1fr; min-height: 100vh; }
    .sidebar{ border-right:1px solid var(--border); background:rgba(18,25,53,.6); backdrop-filter: blur(6px); padding:16px; }
    .header{ display:flex; align-items:center; gap:12px; }
    .brand{ font-weight:700; letter-spacing:.3px; }
    .base{ width:100%; border:1px solid var(--border); background:#0b122b; color:var(--text); border-radius:8px; padding:8px 10px; }
    .row{ display:flex; gap:8px; align-items:center; }
    .pill{ font-size:12px; color:var(--muted); }
    .btn{ background:var(--accent); color:#fff; border:none; border-radius:8px; padding:10px 12px; cursor:pointer; transition:.15s; }
    .btn.secondary{ background:#1a244a; color:var(--text); border:1px solid var(--border); }
    .btn.danger{ background:var(--danger); }
    .btn.ghost{ background:transparent; border:1px solid var(--border); }
    .btn:hover{ transform:translateY(-1px); filter:brightness(1.05); }
    .tickets{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .ticket{ border:1px solid var(--border); background:rgba(12,18,41,.8); border-radius:10px; padding:10px; cursor:pointer; }
    .ticket:hover{ border-color:#2a3d7a; }
    .t-title{ font-weight:600; }
    .t-sub{ font-size:12px; color:var(--muted); }
    .badge{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
    .badge.open{ color:#9bd2ff; border-color:#294d8f; }
    .badge.closed{ color:#9be4c9; border-color:#2a6b55; }
    .badge.human_assigned{ color:#ffd599; border-color:#664b1f; }

    .main{ display:grid; grid-template-rows: auto 1fr auto; padding:18px; gap:14px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; }
    .panel{ border:1px solid var(--border); background:rgba(12,18,41,.6); border-radius:12px; overflow:hidden; }
    .new-ticket{ display:grid; grid-template-columns:1fr 1fr 160px; gap:10px; padding:12px; }
    .chat{ height:100%; display:flex; flex-direction:column; }
    .messages{ flex:1; padding:16px; overflow:auto; display:flex; flex-direction:column; gap:10px; }
    .bubble{ max-width:70%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0a1330; }
    .bubble.customer{ align-self:flex-start; background:#0d1a3a; }
    .bubble.ai{ align-self:flex-end; background:#0a1f2e; border-color:#1c3a52; }
    .meta{ font-size:11px; color:var(--muted); margin-bottom:4px; }
    .composer{ display:flex; gap:10px; padding:12px; border-top:1px solid var(--border); background:#0a1030; }
    .composer input{ flex:1; }
    .admin{ display:flex; gap:8px; padding:12px; border-top:1px solid var(--border); background:#0a1030; align-items:center; }
    .muted{ color:var(--muted); }
    .empty{ padding:24px; text-align:center; color:var(--muted); }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="header">
        <div class="brand">Support Desk</div>
      </div>
      <div class="pill" style="margin-top:10px;">Backend base URL</div>
      <input id="baseUrl" class="base" value="http://localhost:8000" />
      <div class="row" style="margin-top:10px;">
        <select id="statusFilter" class="base">
          <option value="">All statuses</option>
          <option value="open">Open</option>
          <option value="human_assigned">Human assigned</option>
          <option value="closed">Closed</option>
        </select>
        <button class="btn ghost" id="refreshBtn">Refresh</button>
      </div>
      <div class="tickets" id="tickets"></div>
    </aside>
    <main class="main">
      <div class="topbar">
        <div>
          <div style="font-weight:700;">New ticket</div>
          <div class="muted" style="font-size:12px;">Create or continue by context + subject</div>
        </div>
        <button class="btn secondary" id="statsBtn">View stats</button>
      </div>
      <div class="panel">
        <div class="new-ticket">
          <input id="context" class="base" placeholder="Context (e.g., acme)" />
          <input id="subject" class="base" placeholder="Subject (e.g., Password reset)" />
          <div class="row">
            <button class="btn" id="createBtn" style="width:100%;">Create / Continue</button>
          </div>
        </div>
      </div>

      <section class="panel chat" id="chatPanel">
        <div class="messages" id="messages">
          <div class="empty">Select a ticket from the left to view the conversation.</div>
        </div>
        <div class="composer">
          <input id="message" class="base" placeholder="Type a reply and press Send" />
          <button class="btn" id="sendBtn">Send</button>
        </div>
        <div class="admin">
          <input id="agentName" class="base" placeholder="Agent name" style="max-width:200px;" />
          <input id="adminToken" class="base" placeholder="Admin token" style="max-width:200px;" />
          <button class="btn secondary" id="assignBtn">Assign</button>
          <button class="btn danger" id="closeBtn">Close Ticket</button>
          <div class="muted" id="adminStatus"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let currentTicketId = null;

    function base(){ return $('baseUrl').value.replace(/\/+$/,''); }

    function badge(status){
      const cls = status === 'open' ? 'open' : status === 'closed' ? 'closed' : 'human_assigned';
      return `<span class="badge ${cls}">${status}</span>`;
    }

    function renderTickets(list){
      const c = $('tickets');
      if(!list || !list.tickets || list.tickets.length === 0){ c.innerHTML = '<div class="muted">No tickets yet</div>'; return; }
      c.innerHTML = '';
      list.tickets.forEach(t => {
        const el = document.createElement('div');
        el.className = 'ticket';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div class="t-title">${escapeHtml(t.subject || '')}</div>
            ${badge(t.status)}
          </div>
          <div class="t-sub">${escapeHtml(t.context || '')}</div>
        `;
        el.onclick = () => openTicket(t.id);
        c.appendChild(el);
      });
    }

    function renderMessages(thread){
      const m = $('messages');
      if(!thread || !thread.messages || thread.messages.length === 0){ m.innerHTML = '<div class="empty">No messages yet. Start the conversation.</div>'; return; }
      m.innerHTML = '';
      thread.messages.forEach(msg => {
        const wrap = document.createElement('div');
        const role = msg.sender;
        wrap.className = 'bubble ' + (role === 'ai' ? 'ai' : 'customer');
        const ts = new Date(msg.created_at || Date.now()).toLocaleString();
        wrap.innerHTML = `<div class="meta">${escapeHtml(role)} â€¢ ${ts}</div><div>${escapeHtml(msg.message || '')}</div>`;
        m.appendChild(wrap);
      });
      m.scrollTop = m.scrollHeight;
    }

    function setAdminStatus(text){ $('adminStatus').textContent = text || ''; }

    async function listTickets(){
      const status = $('statusFilter').value;
      const url = base() + '/admin/tickets' + (status ? `?status=${encodeURIComponent(status)}` : '');
      try{
        const r = await fetch(url);
        renderTickets(await r.json());
      }catch(e){ renderTickets({ tickets: [] }); }
    }

    async function openTicket(id){
      currentTicketId = id;
      try{
        const r = await fetch(base() + `/ticket/${encodeURIComponent(id)}`);
        const data = await r.json();
        renderMessages(data);
      }catch(e){ $('messages').innerHTML = '<div class="empty">Failed to load thread</div>'; }
    }

    async function createOrContinue(){
      const payload = {
        context: $('context').value.trim(),
        subject: $('subject').value.trim(),
        message: $('message').value.trim() || 'Hello, I need help.'
      };
      if(!payload.context || !payload.subject){ return; }
      try{
        const r = await fetch(base() + '/ticket', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const data = await r.json();
        await listTickets();
        if(data.ticket_id){ await openTicket(data.ticket_id); }
      }catch(e){ /* ignore */ }
    }

    async function sendReply(){
      if(!currentTicketId){ return; }
      const body = { message: $('message').value.trim() };
      if(!body.message){ return; }
      $('message').value = '';
      try{
        const r = await fetch(base() + `/ticket/${encodeURIComponent(currentTicketId)}/reply`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        await openTicket(currentTicketId);
      }catch(e){ /* ignore */ }
    }

    async function assign(){
      if(!currentTicketId){ return; }
      const agent = $('agentName').value.trim() || 'agent-1';
      setAdminStatus('Assigning...');
      try{
        const r = await fetch(base() + `/admin/ticket/${encodeURIComponent(currentTicketId)}/assign?agent_name=${encodeURIComponent(agent)}`, { method:'POST', headers: { ...adminHeaders() } });
        if(!r.ok){
          let msg = 'Failed to assign';
          try { const body = await r.json(); msg = body.detail || body.error || msg; } catch(_){ msg = (await r.text()) || msg; }
          setAdminStatus(`${msg} (status ${r.status})`);
          return;
        }
        const data = await r.json();
        if(data && data.success === true){
          setAdminStatus(data.message || 'Assigned');
        } else {
          setAdminStatus((data && (data.error || data.detail)) || 'Failed to assign');
        }
        await listTickets();
        await openTicket(currentTicketId);
      }catch(e){ setAdminStatus('Failed to assign'); }
    }

    async function closeTicket(){
      if(!currentTicketId){ return; }
      setAdminStatus('Closing...');
      try{
        const r = await fetch(base() + `/admin/ticket/${encodeURIComponent(currentTicketId)}/close`, { method:'POST', headers: { ...adminHeaders() } });
        if(!r.ok){
          let msg = 'Failed to close';
          try { const body = await r.json(); msg = body.detail || body.error || msg; } catch(_){ msg = (await r.text()) || msg; }
          setAdminStatus(`${msg} (status ${r.status})`);
          return;
        }
        const data = await r.json();
        if(data && data.success === true){
          setAdminStatus(data.message || 'Closed');
        } else {
          setAdminStatus((data && (data.error || data.detail)) || 'Failed to close');
        }
        await listTickets();
        await openTicket(currentTicketId);
      }catch(e){ setAdminStatus('Failed to close'); }
    }

    async function viewStats(){
      try{
        const r = await fetch(base() + '/stats');
        const data = await r.json();
        alert('Total: ' + data.total_tickets + '\nOpen: ' + data.open_tickets + '\nClosed: ' + data.closed_tickets);
      }catch(e){ alert('Failed to fetch stats'); }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function adminHeaders(){
      const input = $('adminToken');
      const stored = localStorage.getItem('adminToken') || '';
      const value = (input && input.value ? input.value : stored).trim();
      if(input && input.value){ localStorage.setItem('adminToken', input.value.trim()); }
      return value ? { 'X-Admin-Token': value } : {};
    }

    $('refreshBtn').onclick = listTickets;
    $('createBtn').onclick = createOrContinue;
    $('sendBtn').onclick = sendReply;
    $('assignBtn').onclick = assign;
    $('closeBtn').onclick = closeTicket;
    $('statsBtn').onclick = viewStats;
    $('statusFilter').onchange = listTickets;
    if(localStorage.getItem('adminToken')) { $('adminToken').value = localStorage.getItem('adminToken'); }
    document.addEventListener('keydown', (e) => { if(e.key === 'Enter' && document.activeElement === $('message')){ sendReply(); } });

    listTickets();
  </script>
</body>
</html>